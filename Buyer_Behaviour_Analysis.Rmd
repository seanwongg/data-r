---
title: "AU Market Research"
date: "`r Sys.Date()`"
author: "Vitus Sean Wong"
output:
  html_document:
    code_folding: show
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: no

  editor_options:
  chunk_output_type: console
---
  
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```

```{r packages, include = FALSE}
rm(list=ls())
gc()

require(dplyr)
require(purrr)
require(ggplot2)
require(readxl)
require(lubridate)
require(stringr)
require(RColorBrewer)
require(tidyr)
```

```{r cleaning_df}

df <- read_xlsx("trxn analysis.xlsx", sheet = 2)

max_date <- max(df$Date)
df <- df %>% filter(Date < floor_date(max_date, unit = "month"))
df <- df %>% filter(str_detect(Buyer, "email") !=T)
df <- df %>% mutate(Time = format(Time, "%H:%M:%S"))

no_go_trxn_status <- c("nothing", "canceled", "payment_failed")

df <- df %>% filter((Status %in% no_go_trxn_status) != T)

df <- df %>% mutate(Brand = ifelse(
  str_detect(Product, "Jordan") == T, "Jordans", 
    ifelse(str_detect(Product, "Jordans") == T, "Jordans",
        ifelse(str_detect(Product, "Nike") == T, "Nike", 
            ifelse(str_detect(Product, "nike") == T, "Nike",
                ifelse(str_detect(Product, "Dunk") == T, "Nike",
                    ifelse(str_detect(Product, "dunk") == T, "Nike",
                        ifelse(str_detect(Product, "Dunks") == T, "Nike",
                          ifelse(str_detect(Product, "Yeezy") == T, "Yeezy",
                                 ifelse(str_detect(Product, "Adidas") == T, "adidas",
                                    ifelse(str_detect(Product, "Supreme") == T, "Supreme", 
                                           ifelse(str_detect(Product, "New Balance") == T, "New Balance", 
                                                  ifelse(str_detect(Product, "Travis Scott") == T, "Travis Scott", 
                                                         ifelse(str_detect(Product, "Converse") == T, "Converse",
                                                                ifelse(str_detect(Product, "Vans") == T, "Vans", 
                                                                       ifelse(str_detect(Product, "KAWS") == T, "KAWS", 
                                                                              ifelse(str_detect(Product, "Bearbrick") == T, "Bearbrick", 
                                                                                     ifelse(str_detect(Product, "Fear of God") == T, "FOG", 
                                                                                            ifelse(str_detect(Product, "BAPE") == T, "BAPE",
                                                                                                   ifelse(str_detect(Product, "Reebok") == T, "Reebok",
                                                                                                          ifelse(str_detect(Product, "Anti Social Social Club") == T, "ASSC", 
                                                                                                                 ifelse(str_detect(Product, "Crocs") == T, "Crocs", 
                                                                                                                        ifelse(str_detect(Product, "Puma") == T, "Puma", 
                                                                                                                               ifelse(str_detect(Product, "FR2") == T, "FR2", 
                                                                                                                                      ifelse(str_detect(Product, "Yeezy") == T, "Yeezy", 
                                                                                                                                             ifelse(str_detect(Product, "Kanye") == T, "Yeezy", 
                                                                                                                                                    ifelse(str_detect(Product, "NIKE") == T, "Nike", 
                                                                                                                                                           ifelse(str_detect(Product, "Palace") == T, "Palace", 
                                                                                                                                                                  ifelse(str_detect(Product, "new balance") == T, "New Balance", 
                                                                                                                                                                         ifelse(str_detect(Product, "Drew House") == T, "Drew", 
                                                                                                                                                                         ifelse(str_detect(Product, "New Era") == T, "New Era", 
                                                                                                                                                                                ifelse(str_detect(Product, "Champion") == T, "Champion", 
                                                                                                                                                                                       ifelse(str_detect(Product, "KITH") == T, "Kith",
                                                                                                                                                                                              ifelse(str_detect(Product, "Kith") == T, "Kith", 
                                                                                                                                                                                                     ifelse(str_detect(Product, "The Cap City") == T, "The Cap City", 
                                                                                                                                                                                                            ifelse(str_detect(Product, "ASICS") == T, "ASICS", 
                                                                                                                                                                                                                   ifelse(str_detect(Product, "PALACE") == T, "Palace",                                                                           ifelse(str_detect(Product, "Offâ€")==T, "OW", 
                                                                                                                                                                                                                                                                                                                                                         ifelse(str_detect(Product, "990v1") == T, "New Balance",  ifelse(str_detect(Product, "Samba") == T, "adidas", 
                                                                                                                                                                                                                                                                                                                                                                                                                          ifelse(str_detect(Product, "Under Armour") == T, "Under Armour", ifelse(str_detect(Product, "Alexander McQueen") == T, "Alexander McQueen", ifelse(str_detect(Product, "Asics") == T, "ASICS", 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ifelse(str_detect(Product, "Juice Wrld") == T, "Juice Wrld", 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ifelse(str_detect(Product, "Stussy") == T, "Stussy", 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ifelse(str_detect(Product, "Takashi") == T, "Takashi Murakami", 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ifelse(str_detect(Product, "NBA") == T, "NBA", 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ifelse(str_detect(Product, "Balenciaga") == T, "Balenciaga", ifelse(str_detect(Product, "Virgil Abloh") == T, "OW", Product))))))))))))))))))))))))))))))))))))))
                                        ))
                        )
                    )
                )
            )
        )
    ))))
```

```{r cleaning_df2}
df <- df %>% mutate(Brand = ifelse(str_detect(Brand, "adidas") == T, "adidas", 
ifelse(str_detect(Brand, "Novelship") == T, "Novelship", 
       ifelse(str_detect(Brand, "A Bathing Ape") == T, "BAPE", 
              ifelse(str_detect(Brand, "StÃ¼ssy") == T, "Stussy", 
                     ifelse(str_detect(Brand, "Sony") == T, "Sony", 
                            ifelse(str_detect(Brand, "Air Force 1") == T, "Nike", ifelse(str_detect(Brand, "Dr. Martens") == T, "Dr. Martens", 
                                                                                         ifelse(str_detect(Brand, "Vlone") == T, "Vlone", 
                                                                                                ifelse(str_detect(Brand, "Bape") == T, "BAPE", 
                                                                                                       ifelse(str_detect(Brand, "OFFâ€‘WHITE") == T, "OW", 
                                                                                                              ifelse(str_detect(Brand, "Off White") == T, "OW", 
                                    Brand))))))))))))
```

```{r setting_country}
country <- "AUD"
x = 20
```

# AU  

## Users  

```{r users_cleaning}
users <- read_xlsx("AU Users.xlsx") %>% select(`User ID`, 
                                               `Email Address`, 
                                               `Last Updated Date & Time`, `Creation Date & Time`) %>% 
  rename("Created_at" = "Creation Date & Time", 
         "Updated_at" = "Last Updated Date & Time",
         "email" = "Email Address",
         "id" = "User ID")

users <- users %>% mutate(
  Updated_at = gsub("\\T.*", "", Updated_at),
  Created_at = gsub("\\T.*", "", Created_at),
  Updated_at = as.Date(Updated_at, "%Y-%m-%d"),
  Created_at = as.Date(Created_at, "%Y-%m-%d"),
  Created_month = floor_date(Created_at, unit = "month"),
  id = as.factor(id)
) %>% mutate(email = str_trim(email))

df_users <- df %>% filter(`Buyer Currency` == country) %>% select(Buyer, Date, `Trxn ID`) %>% rename("purchase_date" = "Date") %>% mutate(Buyer = str_trim(Buyer))

# identifying by email, but a better indicator would be user ID

users_base <- users %>% left_join(df_users %>% rename("email" = "Buyer"), by = "email")

new_emails <- users_base %>% filter(is.na(purchase_date) == T) %>% select(email) %>% unique() %>% pull()

users_base$category <- NA

for (i in 1:nrow(users_base)){
  if (is.na(users_base$purchase_date[i]) == T){
    #tagging those who have never made a purchase
    users_base$category[i] <- "newly registered"
  }else if (floor_date(users_base$Created_at[i], unit = "month") == floor_date(users_base$purchase_date[i], unit = "month")){
    #tagging those that made a purchase in the same month as they registered
    users_base$category[i] <- "new buyer"
  }
}

#tagging the first ever purchase made after they have registered

users_base <- users_base %>% ungroup() %>% group_by(email) %>% 
  arrange(purchase_date) %>% 
  mutate(ind = row_number()) #indicate which was the first observation 

for (i in (1:nrow(users_base))){
  if(users_base$ind[i] == 1 & is.na(users_base$category[i])==T){
    users_base$category[i] <- "new buyer"
  }else if (users_base$ind[i] > 1){
    users_base$category[i] <- "existing buyer"
  }
}

users_list <- users_base %>% filter(is.na(email) != T) %>% 
  ungroup() %>% select(`Trxn ID`, category)
```

### Number of Buyers  

```{r}
df <- df %>% left_join(users_list, by = "Trxn ID") %>% 
  mutate(category = ifelse(is.na(category) == T, "existing buyer", category))

ggplot(df %>% mutate(monyear = floor_date(Date, unit = "month")) %>% group_by(monyear) %>% mutate(user_category = as.factor(category)) %>% select(-category) %>%
  count(user_category), 
  aes(x=monyear, y=n, fill = user_category, col = user_category)) + geom_line() + geom_point() + theme_classic() + labs(
    title="Number of Buyers", y = "number of buyers"
  )
```

### GMV by Buyer Type  

```{r}
ggplot(df %>% mutate(monyear = floor_date(Date, unit = "month")) %>% mutate(user_category = as.factor(category)) %>% select(-category) %>%
  group_by(monyear, user_category) %>% summarise(
    gmv = sum(`Price Paid (SGD)`, na.rm=T),
    avg_price = mean(`Price Paid (SGD)`, na.rm=T),
    trxn = n_distinct(`Trxn ID`)
  ), 
  aes(x=monyear, y=gmv, fill = user_category, col = user_category)) + geom_line() + geom_point() + theme_classic() + labs(
    title="GMV", subtitle = "by Buyer Type; solid = GMV, dotted = AOV", y = "GMV"
  ) + geom_line(aes(y=avg_price*1000), linetype="dashed") + scale_y_continuous(sec.axis = sec_axis(~./1000, name = "AOV"))

```

### Existing Buyers  

#### Avg Spend & Trxn  

```{r}
DT::datatable(
  df %>% filter(category == "existing buyer") %>% 
    mutate(quarter = floor_date(Date, unit = 'quarter')) %>% 
    group_by(quarter, Buyer) %>% summarise(trxns = n_distinct(`Trxn ID`, na.rm=T),
                                           avg_spend = mean(`Price Paid (SGD)`, na.rm=T)) %>% ungroup() %>% 
    group_by(quarter) %>% summarise(avg_trxns = mean(trxns, na.rm=T),
                                    spend_sd = sd(avg_spend, na.rm=T),
                                    avg_spend = mean(avg_spend, na.rm=T)
                                    ), caption = "Existing Buyer Avg Trxns / Quarter")
```

#### By Brands  

```{r}
ggplot(df %>% filter(category == "existing buyer") %>% 
                filter(Date >= as.Date("01-01-2022", "%d-%m-%Y")) %>% 
                mutate(monyear = floor_date(Date, unit = "month")) %>% 
                group_by(monyear, Brand) %>% 
                summarise(trxns = n_distinct(`Trxn ID`, na.rm=T))  %>% filter(Brand %in%
c("Nike", "Jordans", "Yeezy", "New Balance", "KAWS", "FOG", "adidas", "Puma")), aes(x=reorder(monyear, Brand), y = trxns, fill = Brand, col = Brand)) + geom_bar(stat="identity", position = "fill") + labs(
                                                                        x="Month", 
                                                                        y="% of trxns",
                                                                        title = "% of Brand by Trxns", subtitle = "by existing buyers"
                                                                      ) + theme(axis.text.x = element_text(angle = 45))
```

### New Buyers  

#### Avg Spend & Trxn  

```{r}
DT::datatable(
  df %>% filter(category == "new buyer") %>% 
    mutate(quarter = floor_date(Date, unit = 'quarter')) %>% 
    group_by(quarter, Buyer) %>% summarise(trxns = n_distinct(`Trxn ID`, na.rm=T),
                                           avg_spend = mean(`Price Paid (SGD)`, na.rm=T)) %>% ungroup() %>% 
    group_by(quarter) %>% summarise(avg_trxns = mean(trxns, na.rm=T),
                                    avg_spend = mean(avg_spend, na.rm=T)), caption = "New Buyer Avg Trxns / Quarter")

DT::datatable(df %>% filter(category == "new buyer") %>% 
                filter(Date >= as.Date("01-01-2022", "%d-%m-%Y")) %>% 
                mutate(monyear = floor_date(Date, unit = "month")) %>% 
                group_by(monyear, Brand) %>% 
                summarise(trxns = n_distinct(`Trxn ID`, na.rm=T)) %>% ungroup() %>%
  arrange(desc(Brand), desc(monyear)))
```

#### By Brands  

```{r}
ggplot(df %>% filter(category == "new buyer") %>% 
                filter(Date >= as.Date("01-01-2022", "%d-%m-%Y")) %>% 
                mutate(monyear = floor_date(Date, unit = "month")) %>% 
                group_by(monyear, Brand) %>% 
                summarise(trxns = n_distinct(`Trxn ID`, na.rm=T))  %>% filter(Brand %in%
 c("Nike", "Jordans", "Yeezy", "New Balance", "adidas", "KAWS", "FOG", "Puma")), aes(x=reorder(monyear, Brand), y = trxns, fill = Brand, col = Brand)) + geom_bar(stat="identity", position = "fill") + labs(
                                                                        x="Month", 
                                                                        y="% of trxns",
                                                                        title = "% of Brand by Trxns", subtitle = "by new buyers"
                                                                      ) + 
  theme(axis.text.x = element_text(angle = 45))
```

### Top Buyers  

#### Top 20 Buyers From Jun 2022  

from 1 Jun 2022 onwards  

```{r}
df %>% filter(Date >= as.Date("01-06-2022", "%d-%m-%Y")) %>% ungroup() %>%
  mutate(Buyer = str_trim(Buyer),
         Buyer = as.factor(Buyer)) %>% filter(category == "existing buyer") %>%
  group_by(Buyer) %>% 
  summarise(gmv = sum(`Price Paid (SGD)`, na.rm=T), 
            trxns = n_distinct(`Trxn ID`, na.rm=T)) %>% arrange(desc(gmv)) %>% slice_head(n = x)
```
#### Top Buyers per Month  

```{r}
ggplot(df %>% filter(Date >= as.Date("01-01-2022", "%d-%m-%Y")) %>% ungroup() %>%
  mutate(Buyer = str_trim(Buyer),
         Buyer = as.factor(Buyer)) %>% filter(category == "existing buyer") %>%
    mutate(monyear = floor_date(Date, unit = "month")) %>% 
  group_by(Buyer, monyear) %>% 
  summarise(gmv = sum(`Price Paid (SGD)`, na.rm=T), 
            trxns = n_distinct(`Trxn ID`, na.rm=T)) %>% ungroup() %>% group_by(monyear) %>% top_n(10), aes(x=monyear, y = gmv, fill = Buyer, col = Buyer)) + geom_bar(stat="identity", position = "stack") + labs(title = "Top 10 Buyers per Month", x = "Month")
```
#### GMV Contribution by Buyer Type  

```{r}
buyer_df <- df %>% filter(Date >= as.Date("01-01-2022", "%d-%m-%Y")) %>% ungroup() %>%
  mutate(Buyer = str_trim(Buyer),
         Buyer = as.factor(Buyer),
         monyear = floor_date(Date, unit = "month")) %>%
  group_by(Buyer, monyear, category) %>% 
  summarise(gmv = sum(`Price Paid (SGD)`, na.rm=T), 
            trxns = n_distinct(`Trxn ID`, na.rm=T)) %>% ungroup()


buyer_df <- buyer_df %>% group_by(monyear) %>% nest()
full_df <- data.frame()
for (i in 1:nrow(buyer_df)){
  monyear <- buyer_df[[1]][[i]]
  mon_df <- buyer_df[[2]][[i]] %>% data.frame()
  new_df <- mon_df %>% filter(category == "new buyer")
  exist_df <- mon_df %>% filter(category == "existing buyer")
  
  exist_df <- exist_df %>% ungroup() %>% arrange(desc(gmv)) %>% mutate(
    ind = row_number()
  )
  exist_df <- exist_df %>% mutate(category = ifelse(ind <= 20, "top20existing", "existing")) %>% select(-ind)
  
  mon_df <- rbind(new_df, exist_df) %>% mutate(monyear = monyear)
  
  full_df <- rbind(full_df, mon_df)
}

ggplot(full_df %>% ungroup() %>% group_by(monyear, category) %>% 
         summarise(gmv = sum(gmv, na.rm=T), 
                   trxns = sum(trxns, na.rm=T )), aes(x=monyear, y = gmv, fill = category, col = category)) + geom_bar(stat="identity", position = "fill")+ labs(title = "GMV Contribution by Buyer Types")
```

## Overall GMV
```{r}
market_trend <- function(country){
  plot <- df %>% filter(`Buyer Currency` == country) %>% 
    mutate(monyear = floor_date(Date, unit = "month")) %>%
    group_by(monyear) %>% summarise(gmv = sum(`Price Paid (SGD)`, na.rm=T),
                                    promo = sum(`Promocode Value (SGD)`, na.rm=T))

  
  
  DT::datatable(plot %>% mutate(`promo_perc%` = round(promo/gmv*100, 2)) %>% 
           select(monyear, gmv, `promo_perc%`))

  ggplot(plot %>% mutate(promo = promo*10) %>% pivot_longer(gmv:promo, names_to = "metric", values_to = "values"), aes(x=monyear, y = values, fill = metric, col = metric)) + geom_line() + geom_point() + scale_y_continuous(sec.axis = sec_axis(~./10)) + theme_classic() + labs(x="Month-Year", y = "SGD$", title = "GMV & Promocode Value", subtitle = "by month trend")
}

market_trend(country)
```
## Promocode Values  

### Promocode by GMV  

```{r}
promocode_cutoff <- function(country){
  df <- df %>% filter(`Buyer Currency` == country) %>% 
    mutate(monyear = floor_date(Date, unit = "month")) 
  
  ggplot(df %>% filter(monyear >= as.Date("01-01-2022", "%d-%m-%Y")), 
         aes(x=`Promocode Value (SGD)`, 
             y=`Price Paid (SGD)`, 
             col = category, fill = category)) + geom_point() + geom_vline(aes(xintercept = median(`Promocode Value (SGD)`, na.rm=T)), colour = "blue") + geom_hline(aes(yintercept = median(`Price Paid (SGD)`, na.rm=T)), colour = "red") + labs(
               title = "Price Paid by Promocode Value Used", 
               subtitle = "in SGD; from 1 Jan 2022 onwards; with median values"
             )
  
}

promocode_cutoff(country)

 print(df %>% 
         mutate(monyear = floor_date(Date, unit = "month")) %>% filter(monyear >= as.Date("01-01-2022", "%d-%m-%Y")) %>% summarise(med_promo = median(`Promocode Value (SGD)`, na.rm=T),
                                                                                  avg_promo = mean(`Promocode Value (SGD)`, na.rm=T),
                                                                                  med_price = median(`Price Paid (SGD)`, na.rm=T), 
                                                                                  avg_price = mean(`Price Paid (SGD)`, na.rm=T)) )
```

We see that the majority of `promocode values` lie **<$XX** and `Price Paid` lie *<$YY*.  

```{r}
promocode_refined <- function(country, greaterthan_date){
  df <- df %>% filter(`Buyer Currency` == country) %>% 
    mutate(monyear = floor_date(Date, unit = "month")) %>% 
    filter(monyear >= greaterthan_date) %>% 
    filter(`Promocode Value (SGD)` < 35) %>% 
    filter(`Price Paid (SGD)` < 400)
  
  
  ggplot(df, 
         aes(x=`Promocode Value (SGD)`, 
             y=`Price Paid (SGD)`, 
             col = category, fill = category)) + geom_point() + geom_vline(aes(xintercept = median(`Promocode Value (SGD)`, na.rm=T)), colour = "blue", linetype = "dashed") + geom_vline(aes(xintercept = mean(`Promocode Value (SGD)`, na.rm=T)), col = "blue") + geom_hline(aes(yintercept = median(`Price Paid (SGD)`, na.rm=T)), colour = "red", linetype = "dashed") + geom_hline(aes(yintercept = mean(`Price Paid (SGD)`, na.rm=T)), colour = "red") + labs(
               title = "Price Paid by Promocode Value Used", 
               subtitle = paste0("in SGD; from ", greaterthan_date," onwards; dashed = median, straight = mean")
             ) + facet_wrap(~category, scales = "free")
  
}

promocode_refined(country, as.Date("01-07-2022", "%d-%m-%Y"))

DT::datatable(df %>% 
         mutate(monyear = floor_date(Date, unit = "month")) %>% filter(monyear >= as.Date("01-01-2022", "%d-%m-%Y")) %>%
           filter(`Promocode Value (SGD)` < 35) %>% filter(`Price Paid (SGD)` < 400) %>% 
           group_by(category) %>% summarise(med_promo = median(`Promocode Value (SGD)`, na.rm=T),
                                                                                  avg_promo = mean(`Promocode Value (SGD)`, na.rm=T), 
                                            promo_75th = quantile(`Promocode Value (SGD)`, 0.75, na.rm=T), 
                                            promo_25th = quantile(`Promocode Value (SGD)`, 0.25, na.rm=T),
                                                                                  med_price = median(`Price Paid (SGD)`, na.rm=T), 
                                                                                  avg_price = mean(`Price Paid (SGD)`, na.rm=T), 
         price_75th = quantile(`Price Paid (SGD)`, 0.75, na.rm=T), 
         price_25th = quantile(`Price Paid (SGD)`, 0.25, na.rm=T))
         )
```

```{r}
corr_promo_price <- function(country){
  df <- df %>% 
    mutate(monyear = floor_date(Date, unit = "month")) %>%
    mutate(category = as.factor(category)) %>%
             filter(monyear >= as.Date("01-07-2022", "%d-%m-%Y")) %>% 
  filter(`Promocode Value (SGD)` < 35) %>% 
  filter(`Price Paid (SGD)` < 400)

# since existing buyer more
  quant_df <- df %>% filter(category == "existing buyer") %>% summarise(exist_promo_75thQ = quantile(`Promocode Value (SGD)`, 0.75, na.rm=T), 
                                                                         exist_price_75thQ = quantile(`Price Paid (SGD)`, 0.75, na.rm=T))
  
  df <- df %>% filter(`Promocode Value (SGD)` < quant_df$exist_promo_75thQ) %>% 
    filter(`Price Paid (SGD)` < quant_df$exist_price_75thQ)
  
  model <- lm(`Price Paid (SGD)` ~ `Promocode Value (SGD)` + category, data = df)
  
  summary(model)
  
}

corr_promo_price(country)
```

With a naive linear regression model, we can see that while reducing the noise of outliers, every promocode value does lead to a lower price paid, by a *factor of almost X*. Naturally, but new buyers seem to increase the overall price paid. 

```{r}
corr_promo_price_user <- function(country, user){
  df <- df %>% 
    mutate(monyear = floor_date(Date, unit = "month")) %>%
    filter(category == user) %>%
             filter(monyear >= as.Date("01-01-2022", "%d-%m-%Y")) %>% 
  filter(`Promocode Value (SGD)` < 35) %>% 
  filter(`Price Paid (SGD)` < 400)

# since existing buyer more
  quant_df <- df %>% summarise(exist_promo_75thQ = quantile(`Promocode Value (SGD)`, 0.55, na.rm=T), 
                                                                         exist_price_75thQ = quantile(`Price Paid (SGD)`, 0.55, na.rm=T))
  
  df <- df %>% filter(`Promocode Value (SGD)` < quant_df$exist_promo_75thQ) %>% 
    filter(`Price Paid (SGD)` < quant_df$exist_price_75thQ)
  
  model <- lm(`Price Paid (SGD)` ~ `Promocode Value (SGD)`, data = df)
  
  summary(model)
  
}

corr_promo_price_user(country, "new buyer")
```

For new users, on average, higher promocodes deter higher priced items.  

```{r}
corr_promo_price_user(country, "existing buyer")
```

Meanwhile existing users, we do see that there is an uplift in promo vs price paid, but ultimately, data suggests to keep between 20 and 30 range.  

## Orders by Time  

```{r}

order_by_time <- function(country){
  ggplot(df %>% filter(`Buyer Currency` == country) %>% mutate(Hour = hour(as.POSIXct(Time, format = "%H:%M:%S"))) %>% 
         group_by(Hour) %>% summarise(trxn = n_distinct(`Trxn ID`), 
                                      gmv = sum(`Price Paid (SGD)`, na.rm=T)),
       aes(x=Hour, y = gmv)) + geom_bar(stat = "identity") + geom_line(aes(y=trxn*100)) + scale_y_continuous(sec.axis = sec_axis(~./100, name = "trxns")) +
  theme_classic() + labs(title = "Sum of GMV vs Trxn", subtitle = "by Hour")

ggplot(df %>% mutate(Hour = hour(as.POSIXct(Time, format = "%H:%M:%S"))) %>% 
         group_by(Hour) %>% summarise(trxn = n_distinct(`Trxn ID`), 
                                      gmv = mean(`Price Paid (SGD)`, na.rm=T)),
       aes(x=Hour, y = gmv)) + geom_bar(stat = "identity") + geom_line(aes(y=trxn/10)) + scale_y_continuous(sec.axis = sec_axis(~.*10, name = "trxns")) +
  theme_classic() + labs(title = "Avg GMV vs Trxn by Hour", subtitle = "bar = Average GMV; line = Transactions")
}

order_by_time(country)
```
```{r}

order_by_time <- function(country, user){
  ggplot(df %>% filter(`Buyer Currency` == country) %>%
           filter(category == user) %>% mutate(Hour = hour(as.POSIXct(Time, format = "%H:%M:%S"))) %>% 
         group_by(Hour) %>% summarise(trxn = n_distinct(`Trxn ID`), 
                                      gmv = sum(`Price Paid (SGD)`, na.rm=T)),
       aes(x=Hour, y = gmv)) + geom_bar(stat = "identity") + geom_line(aes(y=trxn*100)) + scale_y_continuous(sec.axis = sec_axis(~./100, name = "trxns")) +
  theme_classic() + labs(title = "Sum of GMV vs Trxn", subtitle = "by Hour")

ggplot(df %>% filter(`Buyer Currency` == country) %>%
           filter(category == user) %>% mutate(Hour = hour(as.POSIXct(Time, format = "%H:%M:%S"))) %>% 
         group_by(Hour) %>% summarise(trxn = n_distinct(`Trxn ID`), 
                                      gmv = mean(`Price Paid (SGD)`, na.rm=T)),
       aes(x=Hour, y = gmv)) + geom_bar(stat = "identity") + geom_line(aes(y=trxn/10)) + scale_y_continuous(sec.axis = sec_axis(~.*10, name = "trxns")) +
  theme_classic() + labs(title = "Avg GMV vs Trxn by Hour", subtitle = paste("bar = Average GMV; line = Transactions", paste("- ", user)))
}

order_by_time(country, "new buyer")
```

## Top Brands  

### All-Time  

```{r}
top_brand_contribution <- function(country){
  top_brand <- df %>% filter(`Buyer Currency` == country) %>% 
    mutate(monyear = floor_date(Date, unit = "month")) %>%
     mutate(Brand = ifelse(str_detect(Brand, "YEEZY") == T, "Yeezy", 
           ifelse(str_detect(Brand, "adidas") == T, "adidas",
                             Brand))) %>%
    group_by(monyear, Brand) %>% 
    summarise(gmv = sum(`Price Paid (SGD)`, na.rm=T),
              trxn = n_distinct(`Trxn ID`), 
              avg_price = mean(`Price Paid (SGD)`, na.rm=T)) %>% ungroup() %>% 
    arrange(desc(monyear), desc(gmv)) %>% group_by(monyear) %>% 
    slice_max(order_by = gmv, n = 10) %>% 
    filter(Brand != "Louis Vuitton LV Trainer White Black White") %>% 
    filter(Brand != "Daniel Arsham x Pokemon x Uniqlo Pikachu Tee (JP Sizing) Black")

  ggplot(top_brand, aes(x=monyear, y=gmv, fill = Brand, col = Brand)) + geom_bar(stat="identity", position = "stack") 

  DT::datatable(top_brand)
  
  all_time <- top_brand %>% ungroup() %>% group_by(Brand) %>% 
    summarise(gmv = sum(gmv, na.rm=T),
              trxn = sum(trxn, na.rm=T),
              avg_price = mean(avg_price, na.rm=T))
  DT::datatable(all_time %>% arrange(desc(gmv)))
}

top_brand_contribution(country)
```

## Top N Products  

### Top Products per Month  
and their contributions to GMV.  

```{r}

top_x_prod <- function(country, x){
  df <- df %>% filter(`Buyer Currency` == country) %>% 
    filter(Date >= as.Date("01-01-2022", "%d-%m-%Y")) %>%
    mutate(monyear = floor_date(Date, unit = "month"))
  
  top_per_month <- df %>% 
    group_by(monyear, Product) %>% summarise(
      total_sale = sum(`Price Paid (SGD)`)
    ) %>% 
    slice_max(order_by = total_sale, n= x) %>% ungroup() %>% 
    select(monyear, Product, total_sale) %>% 
    left_join(
      df %>% group_by(monyear) %>% summarise(
        month_sale = sum(`Price Paid (SGD)`, na.rm=T)), by = "monyear") %>% unique() %>% ungroup() %>% 
    mutate(contri = round(total_sale/month_sale*100, 2)) %>%
    group_by(monyear) %>% 
    arrange(desc(contri)) %>% arrange(desc(monyear)) %>% ungroup()
  
  DT::datatable(top_per_month %>% select(monyear, Product, contri) %>% 
    mutate(Product = paste(Product, paste0(contri, "%"))) %>% 
    select(monyear, Product) %>% unique() %>% 
    pivot_wider(names_from = "monyear", values_from = "Product") %>% unnest())
}

top_x_prod(country, x)
```

### Contribution of Top Products Trend  

```{r}
#contribution  

top_contri_trend <- function(country, x){
  df <- df %>% filter(`Buyer Currency` == country) %>% 
    mutate(monyear = floor_date(Date, unit = "month"))
  
  top_prod <- df %>% group_by(monyear, Product) %>% 
    summarise(total_sale = sum(`Price Paid (SGD)`)) %>% 
    arrange(desc(monyear), desc(total_sale)) %>% ungroup() %>% 
    group_by(monyear) %>% nest() %>% 
    mutate(data = map(data,
                      ~mutate(.x, 
                              row_num = row_number(),
                              top = ifelse(row_num <= x, "top", "others")))) %>% 
    unnest(cols = c(data))
  
  ggplot(top_prod %>% group_by(monyear, top) %>% 
           summarise(sales = sum(total_sale, na.rm=T)), 
         aes(x=monyear, y = sales, col = top, fill = top)) + geom_bar(stat="identity", position = "dodge") + theme_classic() + 
    labs(x="Month", y = "$", title = "Top Products Contribution Trend", 
         subtitle = paste0("Of Top ", x, " Products of the Month"))
}

top_contri_trend(country, x)


top_contri_trend_user <- function(country, x, user){
  df <- df %>% filter(`Buyer Currency` == country) %>% 
    mutate(monyear = floor_date(Date, unit = "month"))
  
  top_prod <- df %>% group_by(monyear, Product, category) %>% 
    summarise(total_sale = sum(`Price Paid (SGD)`)) %>% 
    arrange(desc(monyear), desc(total_sale)) %>% ungroup() %>% 
    group_by(monyear) %>% nest() %>% 
    mutate(data = map(data,
                      ~mutate(.x, 
                              row_num = row_number(),
                              top = ifelse(row_num <= x, "top", "others")))) %>% 
    unnest(cols = c(data))
  
  ggplot(top_prod %>% filter(category == user) %>% group_by(monyear, top) %>% 
           summarise(sales = sum(total_sale, na.rm=T)), 
         aes(x=monyear, y = sales, col = top, fill = top)) + geom_bar(stat="identity", position = "dodge") + theme_classic() + 
    labs(x="Month", y = "$", title = "Top Products Contribution Trend", 
         subtitle = paste0("Of Top ", x, " Products of the Month for ", user))
}

top_contri_trend_user(country, x, "new buyer")

```

## Momentum Trends  

### Of Top N Products  

```{r}
top_prod_mom <- function(country, x){
  top_prod <- df %>% filter(`Buyer Currency` == country) %>% 
    mutate(monyear = floor_date(Date, unit="month")) %>% group_by(monyear, Product) %>% 
    mutate(total_sale = sum(`Price Paid (SGD)`, na.rm=T),
           trxn = n_distinct(`Trxn ID`),
           avg_price = mean(`Price Paid (SGD)`, na.rm=T)) %>% 
    arrange(desc(monyear), desc(total_sale)) %>% ungroup() %>% 
    group_by(monyear) %>% nest() %>% 
    mutate(data = map(data,
                      ~mutate(.x, 
                              row_num = row_number(),
                              top = ifelse(row_num <= x, "top", "others")))) %>% 
    unnest(cols = c(data)) %>% ungroup() %>%
  arrange(desc(Product), desc(monyear)) %>% 
  select(monyear, Product, top, total_sale, trxn, avg_price) %>% unique() %>% ungroup()
  
  top_prod_names <- top_prod %>% filter(top == "top") %>% select(Product) %>% unique() %>% pull()

  top_prod_mom <- top_prod %>% mutate(top = ifelse(Product %in% top_prod_names, "top", "others")) %>% 
    filter(top == "top")
  
  DT::datatable(top_prod_mom %>% unique())
}

top_prod_mom(country, x)  
```

## Average Price of Shoes  

### Top N Products  


```{r}

top_n_products <- function(country, x, greaterthan_date){
  
  df1 <- df %>% filter(`Buyer Currency` == country) %>% filter(Date >= greaterthan_date)


  by_month <- df1 %>% mutate(monyear = floor_date(Date, unit = "month")) %>% 
  group_by(monyear, Product) %>% summarise(
    trxns = n_distinct(`Trxn ID`),
    gmv = sum(`Price Paid (SGD)`, na.rm=T),
    promo = sum(`Promocode Value (SGD)`, na.rm=T),
    avg_price = gmv/trxns) %>% ungroup() %>% 
  group_by(monyear) %>% arrange(desc(monyear), desc(gmv)) %>% slice_head(n = x)

  DT::datatable(by_month)
  
  top_names <- by_month %>% ungroup() %>% select(Product) %>% unique() %>% pull()
  
  df2 <- df %>% filter(Date >= greaterthan_date) %>% mutate(apr_top = ifelse(Product %in% top_names, "top", "others")) %>% 
    filter(apr_top == "top") %>% 
    mutate(monyear = floor_date(Date, unit = "month")) %>% 
    group_by(monyear, Product) %>% 
    summarise(
      trxns = n_distinct(`Trxn ID`),
      gmv = sum(`Price Paid (SGD)`, na.rm=T),
      promo = sum(`Promocode Value (SGD)`, na.rm=T),
      avg_price = mean(`Price Paid (SGD)`, na.rm=T)
    ) %>% ungroup() %>% arrange(Product, desc(monyear)) %>% 
    group_by(Product) %>% 
    mutate(total_sales = sum(gmv)) %>% 
    ungroup() %>% arrange(desc(total_sales))
  
  top_sales <- df2 %>% select(total_sales) %>% arrange(desc(total_sales)) %>% unique() %>% slice_head(n=x) %>% pull()
  
  order_product_names <- df2 %>% filter(total_sales %in% top_sales) %>% select(Product) %>% unique() %>% pull() 
  
  ggplot(df2 %>% filter(total_sales %in% top_sales) %>%
           mutate(Product = factor(Product, levels = order_product_names)) %>% 
                    group_by(Product) %>% select(-total_sales), 
         aes(x=monyear, y = gmv)) + geom_line(col="red") +  geom_line(aes(y=avg_price*10), col = "blue") +
                    labs(x="Month", y = "$") + scale_y_continuous(sec.axis = sec_axis(~./10, name = "avgprice")) + facet_wrap(~Product, scales = "free") + theme_classic() + labs(title = "Avg Price vs GMV by Month", 
                                                                                                                                                                                  subtitle = "red = gmv; blue = avg price")
}

top_n_products(country, x, as.Date("01-10-2022", "%d-%m-%Y"))
```


```{r}
top_x_prod(country,x)
```


### Overall Average Shoe Prices  

```{r}
overall_avg_shoe_price <- function(country, user){
  ggplot(df %>% filter(`Buyer Currency` == country) %>%
           filter(category == user) %>%
  mutate(monyear = floor_date(Date, unit = "month")) %>% 
  group_by(monyear) %>% 
  summarise(trxns = n_distinct(`Trxn ID`), 
            gmv = sum(`Price Paid (SGD)`, na.rm=T),
            avg_price = mean(`Price Paid (SGD)`, na.rm=T)) %>% ungroup(), 
  aes(x=monyear, y=avg_price)) + geom_line(group = 1) + 
  labs(x="Month", y = "avg price", title = "Avg Price", subtitle = paste("across all items for", user)) + theme_classic()
  
}

overall_avg_shoe_price(country, "existing buyer")
```
